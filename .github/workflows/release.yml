name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Build macOS
        run: |
          mkdir -p dist/keyflip-macos
          go build -o dist/keyflip-macos/keyflip ./cmd/keyflip
          cp layouts.json dist/keyflip-macos/

      - name: Zip macOS
        run: |
          cd dist
          zip -r keyflip-macos-${GITHUB_REF_NAME}.zip keyflip-macos

      - name: Upload macOS Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/keyflip-macos-${{ github.ref_name }}.zip

  build-windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Build Windows
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force dist/keyflip-windows
          go build -o dist/keyflip-windows/keyflip.exe ./cmd/keyflip
          Copy-Item layouts.json dist/keyflip-windows/layouts.json

      - name: Zip Windows
        shell: pwsh
        run: |
          Compress-Archive -Path dist/keyflip-windows -DestinationPath dist/keyflip-windows-$env:GITHUB_REF_NAME.zip

      - name: Upload Windows Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/keyflip-windows-${{ github.ref_name }}.zip
